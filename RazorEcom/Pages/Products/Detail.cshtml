@page "{id:int}"
@model RazorEcom.Pages.Products.DetailModel
@{
    ViewData["Title"] = Model.Product?.Name ?? "Chi tiết sản phẩm";
    Layout = "~/Pages/Shared/_Layout.cshtml";
    var culture = System.Globalization.CultureInfo.GetCultureInfo("vi-VN");
}

<div class="bg-white py-5">
    <div class="container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="/Products/Index" class="text-decoration-none">Cửa hàng</a></li>
                <li class="breadcrumb-item active" aria-current="page">@(Model.Product?.Name)</li>
            </ol>
        </nav>

        @if (Model.Product != null && Model.DefaultVariant != null)
        {
            <div class="row g-5">
                <!-- CỘT TRÁI: ẢNH SẢN PHẨM -->
                <div class="col-lg-6">
                    <div class="position-relative bg-light rounded-4 overflow-hidden shadow-sm">
                        <!-- Sử dụng Placehold.co làm fallback, phù hợp với CSP -->
                        <img src="@(Model.DefaultVariant.ImageUrl ?? Model.Product.ImageUrl ?? "https://placehold.co/600x600?text=No+Image")"
                             class="img-fluid w-100 object-fit-cover"
                             style="aspect-ratio: 1/1;"
                             alt="@Model.Product.Name"
                             onerror="this.src='https://placehold.co/600x600?text=Error'" />
                        
                        @if(Model.DefaultVariant.Quantity < 1)
                        {
                            <span class="position-absolute top-50 start-50 translate-middle badge bg-secondary fs-5 px-4 py-2 opacity-75">HẾT HÀNG</span>
                        }
                    </div>
                </div>

                <!-- CỘT PHẢI: THÔNG TIN -->
                <div class="col-lg-6">
                    <div class="ps-lg-4">
                        <h4 class="text-primary text-uppercase small fw-bold mb-2">@Model.Product.Brand</h4>
                        <h1 class="display-6 fw-bold text-dark mb-3">@Model.Product.Name</h1>
                        
                        <div class="d-flex align-items-center gap-3 mb-4">
                            <span class="h2 fw-bold text-primary mb-0">
                                @Model.DefaultVariant.Price.ToString("C0", culture)
                            </span>
                            
                            @if (Model.DefaultVariant.Quantity > 0)
                            {
                                <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">
                                    <i class="bi bi-check-circle me-1"></i> Còn @Model.DefaultVariant.Quantity
                                </span>
                            }
                        </div>

                        <p class="text-muted lead mb-4">@Model.Product.Description</p>

                        <!-- FORM CHỌN BIẾN THỂ & MUA HÀNG -->
                        <form method="post">
                            <input type="hidden" asp-for="Id" />

                            <div class="card bg-light border-0 rounded-4 p-4 mb-4">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="variantSelector" class="form-label fw-bold text-uppercase small text-muted">Phiên bản (Size - Màu)</label>
                                        <!-- Dropdown tự động chọn variant hiện tại nhờ binding -->
                                        <select id="variantSelector" 
                                                asp-items="Model.VariantOptions" 
                                                class="form-select form-select-lg border-0 shadow-sm">
                                        </select>
                                    </div>

                                    <div class="col-md-4">
                                        <label asp-for="Quantity" class="form-label fw-bold text-uppercase small text-muted">Số lượng</label>
                                        <input asp-for="Quantity" type="number" min="1" max="@Model.DefaultVariant.Quantity"
                                               class="form-control form-control-lg border-0 shadow-sm text-center" />
                                    </div>

                                    <div class="col-md-8 d-flex align-items-end">
                                        <button type="submit" 
                                                class="btn btn-primary btn-lg w-100 h-100 shadow-sm fw-bold"
                                                @(Model.DefaultVariant.Quantity < 1 ? "disabled" : "")>
                                            <i class="bi bi-cart-plus me-2"></i> 
                                            @(Model.DefaultVariant.Quantity < 1 ? "Tạm Hết Hàng" : "Thêm Vào Giỏ")
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <!-- Thông số kỹ thuật nhanh -->
                        <div class="row g-3 small text-muted">
                            <div class="col-6">
                                <div class="border rounded-3 p-3">
                                    <span class="d-block text-uppercase fw-bold mb-1">Mã SKU</span>
                                    <span>@Model.DefaultVariant.Sku</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded-3 p-3">
                                    <span class="d-block text-uppercase fw-bold mb-1">Chất liệu</span>
                                    <span>@Model.DefaultVariant.Material</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <h3>Sản phẩm không tồn tại</h3>
                <a href="/" class="btn btn-primary mt-3">Về trang chủ</a>
            </div>
        }
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const variantSelect = document.getElementById('variantSelector');
            
            if (variantSelect) {
                variantSelect.addEventListener('change', function() {
                    // Lấy ID từ value của option được chọn
                    const selectedId = this.value;
                    
                    // Chuyển hướng trình duyệt sang URL mới
                    // Ví dụ: đang ở /Products/Detail/1 -> chọn ID 2 -> chuyển sang /Products/Detail/2
                    window.location.href = `/Products/Detail/${selectedId}`;
                });
            }
        });
    </script>
}